name: Deploy

on:
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore backend
        run: dotnet restore backend/CasecApi/CasecApi.csproj

      - name: Build backend
        run: dotnet build backend/CasecApi/CasecApi.csproj --configuration Release --no-restore

      - name: Publish backend
        run: dotnet publish backend/CasecApi/CasecApi.csproj --configuration Release --output ./publish/backend --no-build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/casec-frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend/casec-frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend/casec-frontend

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: publish/backend/
          retention-days: 3

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend
          path: frontend/casec-frontend/dist/
          retention-days: 3

      - name: Upload deploy script
        uses: actions/upload-artifact@v4
        with:
          name: deploy-script
          path: Deployment/deploy-iis.ps1
          retention-days: 3

  deploy:
    name: Deploy to IIS
    needs: build
    runs-on: [self-hosted, windows, iis]
    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend
          path: artifacts/backend

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend
          path: artifacts/frontend

      - name: Download deploy script
        uses: actions/download-artifact@v4
        with:
          name: deploy-script
          path: artifacts/scripts

      - name: Deploy to IIS
        shell: powershell
        run: |
          & artifacts\scripts\deploy-iis.ps1 -SiteName "Asso_CASEC" -AppPoolName "Asso_CASEC" -FrontendArtifact "artifacts\frontend" -BackendArtifact "artifacts\backend"

      - name: Run SQL migrations
        shell: powershell
        env:
          DEPLOY_API_KEY: ${{ secrets.DEPLOY_API_KEY }}
        run: |
          Write-Host "[MIGRATIONS] Running deployment SQL..."
          Start-Sleep -Seconds 10
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $headers = @{
            "X-Deploy-Key" = $env:DEPLOY_API_KEY
            "Content-Type" = "application/json"
          }
          # Create Deployments table if it doesn't exist
          $sql = @"
          IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'Deployments')
          BEGIN
            CREATE TABLE Deployments (
              DeploymentId INT IDENTITY(1,1) PRIMARY KEY,
              Summary NVARCHAR(500) NOT NULL,
              CommitHash NVARCHAR(40) NULL,
              Branch NVARCHAR(100) NULL DEFAULT 'main',
              DeployedBy NVARCHAR(100) NULL DEFAULT 'GitHub Actions',
              Status NVARCHAR(20) NOT NULL DEFAULT 'success',
              DurationSeconds INT NULL,
              DeployedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
            );
            CREATE INDEX IX_Deployments_DeployedAt ON Deployments (DeployedAt DESC);
          END
          "@
          $body = @{ sql = $sql } | ConvertTo-Json
          $urls = @("https://app.casecflorida.org/api/admin/migrations/run-sql", "http://app.casecflorida.org/api/admin/migrations/run-sql")
          $success = $false
          foreach ($url in $urls) {
            Write-Host "[MIGRATIONS] Trying $url ..."
            try {
              $response = Invoke-RestMethod -Uri $url -Method POST -Headers $headers -Body $body -TimeoutSec 60
              Write-Host "[MIGRATIONS] $($response.message)"
              $success = $true
              break
            } catch {
              Write-Host "[MIGRATIONS] Failed on $url : $($_.Exception.Message)"
            }
          }
          if (-not $success) {
            Write-Host "[MIGRATIONS] WARN: Could not create Deployments table."
          }
